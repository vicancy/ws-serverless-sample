<html>

<head>
    <title>WebSocket Serverless Chatroom</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script>
        window.apiBaseUrl = 'http://localhost:7071';
    </script>
    <style>
        body,
        html {
            height: 100%;
        }

        .slide-fade-enter-active,
        .slide-fade-leave-active {
            transition: all 1s ease;
        }

        .slide-fade-enter,
        .slide-fade-leave-to {
            height: 0px;
            overflow-y: hidden;
            opacity: 0;
        }
    </style>
</head>

<body>
    <div id="app" class="container h-100">
        <h3>Serverless chat</h3>
        <div class="row" v-if="!ready">
            <div class="col-sm status">
                <div>Loading...</div>
            </div>
        </div>
        <div v-if="ready" class="row h-75" style="overflow: auto;">
            <div class="col-md-3 no-float bg-light p-3">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-home" role="tab"
                        aria-controls="v-pills-home" aria-selected="true">Public</a>
                    <a class="nav-link" id="v-pills-profile-tab" data-toggle="pill" href="#v-pills-profile" role="tab"
                        aria-controls="v-pills-profile" aria-selected="false">Group1</a>
                    <a class="nav-link" id="v-pills-messages-tab" data-toggle="pill" href="#v-pills-messages" role="tab"
                        aria-controls="v-pills-messages" aria-selected="false">Group2</a>
                    <a class="nav-link" id="v-pills-settings-tab" data-toggle="pill" href="#v-pills-settings" role="tab"
                        aria-controls="v-pills-settings" aria-selected="false">Group3</a>
                </div>
            </div>
            <div class="col-md-9 no-float">
                <div class="tab-content" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel"
                        aria-labelledby="v-pills-home-tab">
                        <div>
                            <transition-group name="slide-fade" tag="div" class="h-75 contentDiv"
                                style="overflow: auto;">
                                <div v-for="message in messages" v-bind:key="message.id">
                                    <div class="col-md row" style="display: inline-block;">
                                        <div v-if="message.type ==='system'"
                                            class="text-capitalize font-italic text-info text-center font-weight-light" role="alert">
                                            {{message.text}}
                                        </div>
                                        <div v-if="message.type ==='error'"
                                            class="text-uppercase font-bold text-error text-center font-weight-light" role="alert">
                                            !{{message.code}}!!{{message.text}}
                                        </div>

                                        <div v-if="message.type == 'log'" class="text-muted text-center font-weight-light" role="alert">
                                            {{message.text}}
                                        </div>

                                        <div v-if="message.type == 'alert'"
                                            class="text-capitalize font-italic text-warning text-center font-weight-light" role="alert">
                                            {{message.text}}
                                            <hr />
                                        </div>

                                        <div v-if="message.type == 'self'" class="alert alert-success float-right"
                                            role="text">
                                            {{message.text}}
                                        </div>

                                        <div v-if="!message.type" class="float-left" role="text">
                                            <small class="text-muted font-weight-light">{{message.date}}</small><br/>
                                            <small class="text-muted font-weight-light">From <a href="#">{{message.from}}</a></small>
                                            <p class="alert alert-primary text-break ">{{message.text}}</p>
                                        </div>
                                    </div>
                                </div>
                            </transition-group>
                            <hr />
                            <div class="row p-3">
                                <input type="text" v-model="newMessage" id="message-box" class="col-10"
                                    placeholder="Type message here..." />
                                <button type="button" class="btn btn-primary float-right" style="margin-left: 10;"
                                    v-on:click.prevent="sendNewMessage(checked)">Send</button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-profile" role="tabpanel"
                        aria-labelledby="v-pills-profile-tab">...</div>
                    <div class="tab-pane fade" id="v-pills-messages" role="tabpanel"
                        aria-labelledby="v-pills-messages-tab">...</div>
                    <div class="tab-pane fade" id="v-pills-settings" role="tabpanel"
                        aria-labelledby="v-pills-settings-tab">...</div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>

        <script>
            const data = {
                username: '', // todo: oauth
                defaultgroup: 'public',
                checked: false,
                newMessage: '',
                messages: [],
                myConnectionId: '',
                ready: false
            };
            const app = new Vue({
                el: '#app',
                data: data,
                methods: {
                    sendNewMessage: function (isToGroup) {
                        if (isToGroup) {
                            sendMessage(this.username, null, this.defaultgroup, this.newMessage);
                        }
                        else {
                            sendMessage(this.username, null, null, this.newMessage);
                        }
                        this.newMessage = '';
                    },
                    sendPrivateMessage: function (recipient) {
                        const messageText = prompt('Send private message to ' + recipient);

                        if (messageText) {
                            sendMessage(this.username, recipient, null, messageText);
                        }
                    },
                    addToGroup: function (connectionId, recipient) {
                        var r;
                        if (connectionId) {
                            r = confirm('Add connection ' + connectionId + ' to group: ' + this.defaultgroup);
                        } else {
                            r = confirm('Add user ' + recipient + ' to group: ' + this.defaultgroup);
                        }
                        if (r) {
                            addGroup(this.username, recipient, connectionId, this.defaultgroup);
                        }
                    },
                    removeFromGroup: function (connectionId, recipient) {
                        var r;
                        if (connectionId) {
                            r = confirm('Remove connection ' + connectionId + ' from group: ' + this.defaultgroup);
                        } else {
                            r = confirm('Remove user ' + recipient + ' from group: ' + this.defaultgroup);
                        }
                        if (r) {
                            removeGroup(this.username, recipient, connectionId, this.defaultgroup);
                        }
                    }
                }
            });

            const apiBaseUrl = prompt('Enter the Azure Function app base URL', window.apiBaseUrl);
            data.username = prompt("Enter your username", 'user' + Date.now());
            if (!data.username) {
                alert("No username entered. Reload page and try again.");
                throw "No username entered";
            }

            negotiate().then(info => {
                var url = info.url;

                data.ready = true;

                var websocket = data.websocket = new WebSocket(url);
                websocket.onopen = e => {
                    newMessage({ text: "Connect dectected from client", isPrivate: true, type: 'system' });
                }
                websocket.onclose = e => {
                    newMessage({ text: "Disconnect detected from client", isPrivate: true, type: 'system' });
                }
                websocket.onerror = e => {
                    newMessage({ text: "Error detected from client " + e.data, isPrivate: true, type: 'system' });
                }

                websocket.onmessage = e => {
                    newMessage(JSON.parse(e.data));
                }

            }).catch(alert);

            function getAxiosConfig() {
                const config = {
                    headers: { 'x-ms-signalr-userid': data.username },
                };
                return config;
            }

            function negotiate() {
                return axios.post(`${apiBaseUrl}/api/negotiate?name=${data.username}`, null, getAxiosConfig())
                    .then(resp => resp.data);
            }

            function connect() {

            }
            function sendMessage(sender, recipient, group, messageText) {
                newMessage({ text: messageText, type: 'self' });

                data.websocket.send(JSON.stringify({
                    recipient: recipient,
                    private: recipient != null,
                    group: group,
                    text: messageText
                }));
            }
            function addGroup(sender, recipient, connectionId, group) {
                data.websocket.send(JSON.stringify({
                    action: "add",
                    connectionId: connectionId,
                    recipient: recipient,
                    group: group
                }));
            }
            function removeGroup(sender, recipient, connectionId, group) {
                data.websocket.send(JSON.stringify({
                    action: "remove",
                    connectionId: connectionId,
                    recipient: recipient,
                    group: group
                }));
            }
            let counter = 0;
            function newMessage(message) {
                message.id = counter++; // vue transitions need an id
                data.messages.push(message);
                
                // todo: not that work because the dom is rendered later, use binding?
                var elem = document.getElementsByClassName('contentDiv')[0];
                elem.scrollTop = elem.scrollHeight;
            };
            function newConnection(message) {
                data.myConnectionId = message.ConnectionId;
            }
        </script>
    </div>
</body>

</html>